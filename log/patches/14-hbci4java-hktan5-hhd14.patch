Index: src/challengedata.xml
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/challengedata.xml,v
retrieving revision 1.3
diff -u -r1.3 challengedata.xml
--- src/challengedata.xml	16 May 2011 15:39:50 -0000	1.3
+++ src/challengedata.xml	17 May 2011 16:37:49 -0000
@@ -9,525 +9,804 @@
   code CDATA #REQUIRED
 >
 
-<!ELEMENT challengeinfo (klass,param*,value?,curr?)>
+<!ELEMENT challengeinfo (klass,param*)>
 <!ATTLIST challengeinfo
   spec CDATA #REQUIRED
 >
 
 <!ELEMENT klass (#PCDATA)>
 <!ELEMENT param (#PCDATA)>
-<!ELEMENT value (#PCDATA)>
-<!ELEMENT curr  (#PCDATA)>
+<!ATTLIST param
+  type CDATA ""
+  condition-name CDATA #IMPLIED
+  condition-value CDATA #IMPLIED
+>
 
 ]>
 
 <challengedata>
-    <!-- beim Versenden eines Jobs müssen u.U. eine Challenge-Klasse, Challenge-
-         Parameter sowie evtl. auch ein Challenge-Wert übertragen werden.
-         
-         Für die Zuordnung der Jobs zu den Challenge-Klassen und den jeweils
-         benötigten Parametern könnte es unterschiedliche Spezifikationen
-         geben (im Moment ist nur HHD-1.2 bekannt).
-         
-         Hier wird nun für jeden Job definiert, welche Challenge-Klasse zu
-         diesem Job gehört und wie der Pfad zu dem (den) Datenelement(en)
-         lautet, die die jeweils benötigten Challenge-Parameter enthalten.
-         Außerdem wird der Pfad zum Challenge-Wert und zur -Währung definiert.
+  <!--
+     beim Versenden eines Jobs muessen u.U. eine Challenge-Klasse, Challenge-
+     Parameter sowie evtl. auch ein Challenge-Wert uebertragen werden.
+       
+     Hier wird nun fuer jeden Job definiert, welche Challenge-Klasse zu
+     diesem Job gehoert und wie der Pfad zu dem (den) Datenelement(en)
+     lautet, die die jeweils benoetigten Challenge-Parameter enthalten.
          
-         Das ganze jeweils für jede Spezifikation separat.
-    -->
+     Das ganze jeweils fuer jede Spezifikation separat.
+  -->
 
-    <job code="DKTAZ">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKAOM">
-        <challengeinfo spec="hhd12">
-            <klass>20</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>20</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKAUE">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKAZK">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKCCS">
-        <challengeinfo spec="hhd12">
-            <klass>22</klass>
-            <param>sepa.dst.iban</param>
-            <value>sepa.btg.value</value>
-            <curr>sepa.btg.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>22</klass>
-            <param>SegHead.code</param>
-            <param>sepa.dst.iban</param>
-            <value>sepa.btg.value</value>
-            <curr>sepa.btg.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKDAB">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKDAE">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKDAL">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKDAN">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKDTE">
-        <challengeinfo spec="hhd12">
-            <klass>50</klass>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>50</klass>
-	    <param>SegHead.code</param>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKEIL">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKEKA">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKFGB">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKFGK">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKFGN">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Belastungskto.number</param>
-            <value>Anlagebetrag.value</value>
-            <curr>Anlagebetrag.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Belastungskto.number</param>
-            <value>Anlagebetrag.value</value>
-            <curr>Anlagebetrag.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKGUB">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKINF">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKLAS">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKLSW">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKKAN">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKKAZ">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKKDM">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKKIA">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKKIF">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKKOM">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKPAE">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKPRO">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKSAL">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKSLA">
-        <challengeinfo spec="hhd12">
-            <klass>50</klass>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>50</klass>
-	    <param>SegHead.code</param>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKSLB">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKSLE">
-        <challengeinfo spec="hhd12">
-            <klass>50</klass>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>50</klass>
-	    <param>SegHead.code</param>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKSLL">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKSUB">
-        <challengeinfo spec="hhd12">
-            <klass>50</klass>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>50</klass>
-	    <param>SegHead.code</param>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTAZ">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTSB">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTSE">
-        <challengeinfo spec="hhd12">
-            <klass>50</klass>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>50</klass>
-	    <param>SegHead.code</param>
-            <param>sumOthers</param>
-            <value>sumValue</value>
-            <curr>sumCurr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTSL">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTUA">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTUB">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTUE">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKTUL">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKUEB">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKUMB">
-        <challengeinfo spec="hhd12">
-            <klass>10</klass>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-        <challengeinfo spec="hhd13">
-            <klass>10</klass>
-	    <param>SegHead.code</param>
-            <param>Other.number</param>
-            <value>BTG.value</value>
-            <curr>BTG.curr</curr>
-        </challengeinfo>
-    </job>
-
-    <job code="HKWDU">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKWPD">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKWPI">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKWPK">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKWPR">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
-
-    <job code="HKWSD">
-        <challengeinfo spec="hhd12">
-            <klass>90</klass>
-        </challengeinfo>
-    </job>
+  <job code="DKTAZ">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>64</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKAOM">
+    <challengeinfo spec="hhd12">
+      <klass>20</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>20</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>10</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>otheriban</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKAUE">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKAZK">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKCCS">
+    <challengeinfo spec="hhd12">
+      <klass>22</klass>
+      <param>sepa.dst.iban</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sepa.btg.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">sepa.btg.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>22</klass>
+      <param>SegHead.code</param>
+      <param>sepa.dst.iban</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sepa.btg.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">sepa.btg.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>09</klass>
+      <param type="value">sepa.btg.value</param>
+      <param>sepa.dst.iban</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKDAB">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKDAE">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>34</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKDAL">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>40</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>orderid</param>
+      <param type="value">BTG.value</param>
+      <param>My.number</param>
+      <param></param>          <!-- IBAN Empfaenger -->
+      <param>Other.number</param>
+      <param></param>          <!-- ISIN -->
+      <param></param>          <!-- WP-Kenn-Nr -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKDAN">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>43</klass>
+      <param></param>          <!-- Anzahl -->
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param></param>          <!-- IBAN Empfaenger -->
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKDTE">
+    <challengeinfo spec="hhd12">
+      <klass>50</klass>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>50</klass>
+      <param>SegHead.code</param>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>12</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKEIL">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>04</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKEKA">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>51</klass>
+      <param>My.KIK.blz</param>
+      <param></param>          <!-- eigene IBAN -->
+      <param>My.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKFGB">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl, Abhaengig vom BPD-Parameter "Eingabe Anzahl Eintraege erlaubt" -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKFGK">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl, Abhaengig vom BPD-Parameter "Eingabe Anzahl Eintraege erlaubt" -->
+      <param></param>          <!-- BLZ Absender -->
+      <param></param>          <!-- IBAN Absender -->
+      <param></param>          <!-- Konto Absender -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKFGN">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Belastungskto.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">Anlagebetrag.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">Anlagebetrag.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Belastungskto.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">Anlagebetrag.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">Anlagebetrag.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>59</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKGUB">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>04</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKINF">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>63</klass>
+      <param>Address.plz</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKLAS">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>15</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKLSW">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>16</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKKAN">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl, Abhaengig vom BPD-Parameter "Eingabe Anzahl Eintraege erlaubt" -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKKAZ">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl, Abhaengig vom BPD-Parameter "Eingabe Anzahl Eintraege erlaubt" -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKKDM">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>63</klass>
+      <param></param>          <!-- Postleitzahl -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKKIA">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param></param>          <!-- BLZ Absender -->
+      <param></param>          <!-- IBAN Absender -->
+      <param></param>          <!-- Konto Absender -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKKIF">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKKOM">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKPAE">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>63</klass>
+      <param></param>          <!-- Postleitzahl -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKPRO">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param></param>          <!-- BLZ Absender -->
+      <param></param>          <!-- IBAN Absender -->
+      <param></param>          <!-- Konto Absender -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKSAL">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKSLA">
+    <challengeinfo spec="hhd12">
+      <klass>50</klass>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>50</klass>
+      <param>SegHead.code</param>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>19</klass>
+      <param>sumCount</param>
+      <param type="value">sumValue</param>
+      <param>KTV.number</param>
+      <param>sumOthers</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKSLB">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKSLE">
+    <challengeinfo spec="hhd12">
+      <klass>50</klass>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>50</klass>
+      <param>SegHead.code</param>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>31</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKSLL">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>40</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKSUB">
+    <challengeinfo spec="hhd12">
+      <klass>50</klass>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>50</klass>
+      <param>SegHead.code</param>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>12</klass>
+      <param>sumCount</param>
+      <param type="value">sumValue</param>
+      <param>KTV.number</param>
+      <param>sumOthers</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKTAZ">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>64</klass>
+      <param></param>          <!-- Kartennummer -->
+      <param></param>          <!-- Mobilfunknr -->
+      <param></param>          <!-- Referenzkonto -->
+      <param></param>          <!-- TAN-Medium -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKTSB">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKTSE">
+    <challengeinfo spec="hhd12">
+      <klass>50</klass>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>50</klass>
+      <param>SegHead.code</param>
+      <param>sumOthers</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">sumValue</param>
+      <param condition-name="needchallengevalue" condition-value="J">sumCurr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>25</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKTSL">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>40</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKTUA">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>43</klass>
+      <param></param>          <!-- Anzahl -->
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param></param>          <!-- IBAN Empfaenger -->
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKTUB">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>KTV.KIK.blz</param>
+      <param></param>          <!-- IBAN Absender -->
+      <param>KTV.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKTUE">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>22</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>Other.number</param>
+      <param>date</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKTUL">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>40</klass>
+      <param></param>          <!-- Anzahl -->
+      <param>id</param>
+      <param></param>          <!-- Betrag -->
+      <param></param>          <!-- Eigenes Konto -->
+      <param></param>          <!-- IBAN Empfaenger -->
+      <param></param>          <!-- Konto Empfaenger -->
+      <param></param>          <!-- ISIN -->
+      <param></param>          <!-- WP-Kenn-Nr -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKUEB">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>04</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.KIK.blz</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKUMB">
+    <challengeinfo spec="hhd12">
+      <klass>10</klass>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd13">
+      <klass>10</klass>
+      <param>SegHead.code</param>
+      <param>Other.number</param>
+      <param condition-name="needchallengevalue" condition-value="J" type="value">BTG.value</param>
+      <param condition-name="needchallengevalue" condition-value="J">BTG.curr</param>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>05</klass>
+      <param type="value">BTG.value</param>
+      <param>Other.number</param>
+    </challengeinfo>
+  </job>
+
+  <job code="HKWDU">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKWPD">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKWPI">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKWPK">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKWPR">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
+
+  <job code="HKWSD">
+    <challengeinfo spec="hhd12">
+      <klass>90</klass>
+    </challengeinfo>
+    <challengeinfo spec="hhd14">
+      <klass>39</klass>
+      <!-- keine GV-Klasse vorhanden -->
+    </challengeinfo>
+  </job>
 </challengedata>
Index: src/hbci-201.xml
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/hbci-201.xml,v
retrieving revision 1.1
diff -u -r1.1 hbci-201.xml
--- src/hbci-201.xml	4 May 2011 22:37:50 -0000	1.1
+++ src/hbci-201.xml	17 May 2011 16:37:50 -0000
@@ -1245,6 +1245,19 @@
             </valids>
         </DEGdef>
         
+        <DEGdef id="ParTAN2Step5">
+            <DE name="can1step" type="JN"/>
+            <DE name="canmultitangvs" type="JN"/>
+            <DE name="orderhashmode" type="Code" maxsize="1"/>
+            <DEG type="TAN2StepParams5" name="TAN2StepParams" maxnum="98"/>
+            
+            <valids path="orderhashmode">
+                <validvalue>0</validvalue>
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="ParTemplateD">
             <DE name="dummy" type="AN" minsize="0" maxsize="999" minnum="2" maxnum="999"/>
         </DEGdef>
@@ -1514,6 +1527,40 @@
             </valids>
         </DEGdef>
 
+        <DEGdef id="TAN2StepParams5">
+            <DE name="secfunc" type="Code" maxsize="3"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="id" type="ID"/>
+            <DE name="zkamethod_name" type="AN" maxsize="32" minnum="0" />
+            <DE name="zkamethod_version" type="AN" maxsize="10" minnum="0" />
+            <DE name="name" type="AN" maxsize="30"/>
+            <DE name="maxlentan2step" type="Num" maxsize="2"/>
+            <DE name="tanformat" type="Code" maxsize="1"/>
+            <DE name="inputinfo" type="AN" maxsize="30"/>
+            <DE name="maxleninput2step" type="Num" maxsize="4"/>
+            <DE name="noftanlists" type="Num" maxsize="1" minnum="0"/>
+            <DE name="canmultitan" type="JN"/>
+            <DE name="cantandelay" type="Code" maxsize="1"/>
+            <DE name="needtanlistidx" type="Code" maxsize="1"/>
+            <DE name="canstorno" type="JN"/>
+            <DE name="needsmsaccount" type="Code" maxsize="1"/>
+            <DE name="needorderaccount" type="Code" maxsize="1"/>
+            <DE name="needchallengeklass" type="JN"/>
+            <DE name="ischallengestructured" type="JN" />
+            <DE name="initmode" type="Code"/>
+            <DE name="needtanmedia" type="Code"/>
+            <DE name="nofactivetanmedia" type="Num" maxsize="1" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+            <valids path="tanformat">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="TANInfo">
             <DE name="usagecode" type="Code" maxsize="2"/>
             <DE name="usagetxt" type="AN" maxsize="99" minnum="0"/>
@@ -4484,6 +4531,70 @@
             <value path="SegHead.version">4</value>
         </SEGdef>
 
+
+
+        <!--  willuhn 2011-05-16 BEGIN HKTAN/HITAN/HITANS Version 5 -->
+        <SEGdef id="TAN2Step5" needsRequestTag="1">
+            <DEG type="SegHeadUser" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="ordersegcode" type="AN" maxsize="6" minnum="0"/>
+            <DEG name="OrderAccount" type="KTV3" minnum="0" />
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="notlasttan" type="JN" minnum="0"/>
+            <DE name="storno" type="JN" minnum="0"/>
+            <DEG name="SMSAccount" type="KTV3" minnum="0" />
+            <DE name="challengeklass" type="Num" maxsize="2" minnum="0"/>
+            <DEG type="ChallengeKlassParams" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HKTAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepRes5">
+            <DEG type="SegHeadInst" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="challenge" type="AN" maxsize="2048" minnum="0"/>
+            <DE name="challenge_hhd_uc" type="Bin" maxsize="0" minnum="0" />
+            <DEG type="ChallengeValidity" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="ben" type="AN" maxsize="99" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HITAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepPar5">
+            &GVP2;
+            <DEG type="ParTAN2Step5" name="ParTAN2Step"/>
+            
+            &SecClassValids;
+            
+            <value path="SegHead.code">HITANS</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <!--  willuhn 2011-05-16 END HKTAN/HITAN/HITANS Version 5 -->
+
+
+
+
         <SEGdef id="TANListList1" needsRequestTag="1"> <!-- 2.2 -->
             <DEG type="SegHeadUser" name="SegHead"/>
 
@@ -6102,6 +6213,7 @@
             <SEG type="TAN2Step2" minnum="0"/>
             <SEG type="TAN2Step3" minnum="0"/>
             <SEG type="TAN2Step4" minnum="0"/>
+            <SEG type="TAN2Step5" minnum="0"/>
             <SEG type="TANListList1" minnum="0"/>
             <SEG type="TermSammelLast3" minnum="0"/>
             <SEG type="TermSammelLastDel3" minnum="0"/>
@@ -6220,6 +6332,7 @@
             <SEG type="TAN2StepRes2" minnum="0"/>
             <SEG type="TAN2StepRes3" minnum="0"/>
             <SEG type="TAN2StepRes4" minnum="0"/>
+            <SEG type="TAN2StepRes5" minnum="0"/>
             <SEG type="TANListListRes1" minnum="0"/>
             <SEG type="TermSammelLastRes3" minnum="0"/>
             <SEG type="TermSammelLastListRes3" minnum="0"/>
@@ -6352,6 +6465,7 @@
             <SEG type="TAN2StepPar2" minnum="0"/>
             <SEG type="TAN2StepPar3" minnum="0"/>
             <SEG type="TAN2StepPar4" minnum="0"/>
+            <SEG type="TAN2StepPar5" minnum="0"/>
             <SEG type="TANListListPar1" minnum="0"/>
             <SEG type="TermSammelLastPar3" minnum="0"/>
             <SEG type="TermSammelLastDelPar3" minnum="0"/>
Index: src/hbci-210.xml
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/hbci-210.xml,v
retrieving revision 1.1
diff -u -r1.1 hbci-210.xml
--- src/hbci-210.xml	4 May 2011 22:37:50 -0000	1.1
+++ src/hbci-210.xml	17 May 2011 16:37:52 -0000
@@ -1245,6 +1245,19 @@
             </valids>
         </DEGdef>
         
+        <DEGdef id="ParTAN2Step5">
+            <DE name="can1step" type="JN"/>
+            <DE name="canmultitangvs" type="JN"/>
+            <DE name="orderhashmode" type="Code" maxsize="1"/>
+            <DEG type="TAN2StepParams5" name="TAN2StepParams" maxnum="98"/>
+            
+            <valids path="orderhashmode">
+                <validvalue>0</validvalue>
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="ParTemplateD">
             <DE name="dummy" type="AN" minsize="0" maxsize="999" minnum="2" maxnum="999"/>
         </DEGdef>
@@ -1514,6 +1527,40 @@
             </valids>
         </DEGdef>
 
+        <DEGdef id="TAN2StepParams5">
+            <DE name="secfunc" type="Code" maxsize="3"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="id" type="ID"/>
+            <DE name="zkamethod_name" type="AN" maxsize="32" minnum="0" />
+            <DE name="zkamethod_version" type="AN" maxsize="10" minnum="0" />
+            <DE name="name" type="AN" maxsize="30"/>
+            <DE name="maxlentan2step" type="Num" maxsize="2"/>
+            <DE name="tanformat" type="Code" maxsize="1"/>
+            <DE name="inputinfo" type="AN" maxsize="30"/>
+            <DE name="maxleninput2step" type="Num" maxsize="4"/>
+            <DE name="noftanlists" type="Num" maxsize="1" minnum="0"/>
+            <DE name="canmultitan" type="JN"/>
+            <DE name="cantandelay" type="Code" maxsize="1"/>
+            <DE name="needtanlistidx" type="Code" maxsize="1"/>
+            <DE name="canstorno" type="JN"/>
+            <DE name="needsmsaccount" type="Code" maxsize="1"/>
+            <DE name="needorderaccount" type="Code" maxsize="1"/>
+            <DE name="needchallengeklass" type="JN"/>
+            <DE name="ischallengestructured" type="JN" />
+            <DE name="initmode" type="Code"/>
+            <DE name="needtanmedia" type="Code"/>
+            <DE name="nofactivetanmedia" type="Num" maxsize="1" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+            <valids path="tanformat">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="TANInfo">
             <DE name="usagecode" type="Code" maxsize="2"/>
             <DE name="usagetxt" type="AN" maxsize="99" minnum="0"/>
@@ -4484,6 +4531,70 @@
             <value path="SegHead.version">4</value>
         </SEGdef>
 
+
+
+        <!--  willuhn 2011-05-16 BEGIN HKTAN/HITAN/HITANS Version 5 -->
+        <SEGdef id="TAN2Step5" needsRequestTag="1">
+            <DEG type="SegHeadUser" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="ordersegcode" type="AN" maxsize="6" minnum="0"/>
+            <DEG name="OrderAccount" type="KTV3" minnum="0" />
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="notlasttan" type="JN" minnum="0"/>
+            <DE name="storno" type="JN" minnum="0"/>
+            <DEG name="SMSAccount" type="KTV3" minnum="0" />
+            <DE name="challengeklass" type="Num" maxsize="2" minnum="0"/>
+            <DEG type="ChallengeKlassParams" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HKTAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepRes5">
+            <DEG type="SegHeadInst" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="challenge" type="AN" maxsize="2048" minnum="0"/>
+            <DE name="challenge_hhd_uc" type="Bin" maxsize="0" minnum="0" />
+            <DEG type="ChallengeValidity" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="ben" type="AN" maxsize="99" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HITAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepPar5">
+            &GVP2;
+            <DEG type="ParTAN2Step5" name="ParTAN2Step"/>
+            
+            &SecClassValids;
+            
+            <value path="SegHead.code">HITANS</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <!--  willuhn 2011-05-16 END HKTAN/HITAN/HITANS Version 5 -->
+
+
+
+
         <SEGdef id="TANListList1" needsRequestTag="1"> <!-- 2.2 -->
             <DEG type="SegHeadUser" name="SegHead"/>
 
@@ -6102,6 +6213,7 @@
             <SEG type="TAN2Step2" minnum="0"/>
             <SEG type="TAN2Step3" minnum="0"/>
             <SEG type="TAN2Step4" minnum="0"/>
+            <SEG type="TAN2Step5" minnum="0"/>
             <SEG type="TANListList1" minnum="0"/>
             <SEG type="TermSammelLast3" minnum="0"/>
             <SEG type="TermSammelLastDel3" minnum="0"/>
@@ -6220,6 +6332,7 @@
             <SEG type="TAN2StepRes2" minnum="0"/>
             <SEG type="TAN2StepRes3" minnum="0"/>
             <SEG type="TAN2StepRes4" minnum="0"/>
+            <SEG type="TAN2StepRes5" minnum="0"/>
             <SEG type="TANListListRes1" minnum="0"/>
             <SEG type="TermSammelLastRes3" minnum="0"/>
             <SEG type="TermSammelLastListRes3" minnum="0"/>
@@ -6352,6 +6465,7 @@
             <SEG type="TAN2StepPar2" minnum="0"/>
             <SEG type="TAN2StepPar3" minnum="0"/>
             <SEG type="TAN2StepPar4" minnum="0"/>
+            <SEG type="TAN2StepPar5" minnum="0"/>
             <SEG type="TANListListPar1" minnum="0"/>
             <SEG type="TermSammelLastPar3" minnum="0"/>
             <SEG type="TermSammelLastDelPar3" minnum="0"/>
Index: src/hbci-220.xml
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/hbci-220.xml,v
retrieving revision 1.1
diff -u -r1.1 hbci-220.xml
--- src/hbci-220.xml	4 May 2011 22:37:50 -0000	1.1
+++ src/hbci-220.xml	17 May 2011 16:37:52 -0000
@@ -1244,6 +1244,19 @@
             </valids>
         </DEGdef>
         
+        <DEGdef id="ParTAN2Step5">
+            <DE name="can1step" type="JN"/>
+            <DE name="canmultitangvs" type="JN"/>
+            <DE name="orderhashmode" type="Code" maxsize="1"/>
+            <DEG type="TAN2StepParams5" name="TAN2StepParams" maxnum="98"/>
+            
+            <valids path="orderhashmode">
+                <validvalue>0</validvalue>
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="ParTemplateD">
             <DE name="dummy" type="AN" minsize="0" maxsize="999" minnum="2" maxnum="999"/>
         </DEGdef>
@@ -1513,6 +1526,40 @@
             </valids>
         </DEGdef>
 
+        <DEGdef id="TAN2StepParams5">
+            <DE name="secfunc" type="Code" maxsize="3"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="id" type="ID"/>
+            <DE name="zkamethod_name" type="AN" maxsize="32" minnum="0" />
+            <DE name="zkamethod_version" type="AN" maxsize="10" minnum="0" />
+            <DE name="name" type="AN" maxsize="30"/>
+            <DE name="maxlentan2step" type="Num" maxsize="2"/>
+            <DE name="tanformat" type="Code" maxsize="1"/>
+            <DE name="inputinfo" type="AN" maxsize="30"/>
+            <DE name="maxleninput2step" type="Num" maxsize="4"/>
+            <DE name="noftanlists" type="Num" maxsize="1" minnum="0"/>
+            <DE name="canmultitan" type="JN"/>
+            <DE name="cantandelay" type="Code" maxsize="1"/>
+            <DE name="needtanlistidx" type="Code" maxsize="1"/>
+            <DE name="canstorno" type="JN"/>
+            <DE name="needsmsaccount" type="Code" maxsize="1"/>
+            <DE name="needorderaccount" type="Code" maxsize="1"/>
+            <DE name="needchallengeklass" type="JN"/>
+            <DE name="ischallengestructured" type="JN" />
+            <DE name="initmode" type="Code"/>
+            <DE name="needtanmedia" type="Code"/>
+            <DE name="nofactivetanmedia" type="Num" maxsize="1" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+            <valids path="tanformat">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="TANInfo">
             <DE name="usagecode" type="Code" maxsize="2"/>
             <DE name="usagetxt" type="AN" maxsize="99" minnum="0"/>
@@ -4483,6 +4530,72 @@
             <value path="SegHead.version">4</value>
         </SEGdef>
 
+
+
+
+        <!--  willuhn 2011-05-16 BEGIN HKTAN/HITAN/HITANS Version 5 -->
+        <SEGdef id="TAN2Step5" needsRequestTag="1">
+            <DEG type="SegHeadUser" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="ordersegcode" type="AN" maxsize="6" minnum="0"/>
+            <DEG name="OrderAccount" type="KTV3" minnum="0" />
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="notlasttan" type="JN" minnum="0"/>
+            <DE name="storno" type="JN" minnum="0"/>
+            <DEG name="SMSAccount" type="KTV3" minnum="0" />
+            <DE name="challengeklass" type="Num" maxsize="2" minnum="0"/>
+            <DEG type="ChallengeKlassParams" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HKTAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepRes5">
+            <DEG type="SegHeadInst" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="challenge" type="AN" maxsize="2048" minnum="0"/>
+            <DE name="challenge_hhd_uc" type="Bin" maxsize="0" minnum="0" />
+            <DEG type="ChallengeValidity" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="ben" type="AN" maxsize="99" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HITAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepPar5">
+            &GVP2;
+            <DEG type="ParTAN2Step5" name="ParTAN2Step"/>
+            
+            &SecClassValids;
+            
+            <value path="SegHead.code">HITANS</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <!--  willuhn 2011-05-16 END HKTAN/HITAN/HITANS Version 5 -->
+
+
+
+
+
         <SEGdef id="TANListList1" needsRequestTag="1"> <!-- 2.2 -->
             <DEG type="SegHeadUser" name="SegHead"/>
 
@@ -6101,6 +6214,7 @@
             <SEG type="TAN2Step2" minnum="0"/>
             <SEG type="TAN2Step3" minnum="0"/>
             <SEG type="TAN2Step4" minnum="0"/>
+            <SEG type="TAN2Step5" minnum="0"/>
             <SEG type="TANListList1" minnum="0"/>
             <SEG type="TermSammelLast3" minnum="0"/>
             <SEG type="TermSammelLastDel3" minnum="0"/>
@@ -6219,6 +6333,7 @@
             <SEG type="TAN2StepRes2" minnum="0"/>
             <SEG type="TAN2StepRes3" minnum="0"/>
             <SEG type="TAN2StepRes4" minnum="0"/>
+            <SEG type="TAN2StepRes5" minnum="0"/>
             <SEG type="TANListListRes1" minnum="0"/>
             <SEG type="TermSammelLastRes3" minnum="0"/>
             <SEG type="TermSammelLastListRes3" minnum="0"/>
@@ -6351,6 +6466,7 @@
             <SEG type="TAN2StepPar2" minnum="0"/>
             <SEG type="TAN2StepPar3" minnum="0"/>
             <SEG type="TAN2StepPar4" minnum="0"/>
+            <SEG type="TAN2StepPar5" minnum="0"/>
             <SEG type="TANListListPar1" minnum="0"/>
             <SEG type="TermSammelLastPar3" minnum="0"/>
             <SEG type="TermSammelLastDelPar3" minnum="0"/>
Index: src/hbci-300.xml
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/hbci-300.xml,v
retrieving revision 1.1
diff -u -r1.1 hbci-300.xml
--- src/hbci-300.xml	4 May 2011 22:37:50 -0000	1.1
+++ src/hbci-300.xml	17 May 2011 16:37:52 -0000
@@ -1308,6 +1308,19 @@
             </valids>
         </DEGdef>
         
+        <DEGdef id="ParTAN2Step5">
+            <DE name="can1step" type="JN"/>
+            <DE name="canmultitangvs" type="JN"/>
+            <DE name="orderhashmode" type="Code" maxsize="1"/>
+            <DEG type="TAN2StepParams5" name="TAN2StepParams" maxnum="98"/>
+            
+            <valids path="orderhashmode">
+                <validvalue>0</validvalue>
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="ParTemplateD">
             <DE name="dummy" type="AN" minsize="0" maxsize="999" minnum="2" maxnum="999"/>
         </DEGdef>
@@ -1577,6 +1590,40 @@
             </valids>
         </DEGdef>
 
+        <DEGdef id="TAN2StepParams5">
+            <DE name="secfunc" type="Code" maxsize="3"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="id" type="ID"/>
+            <DE name="zkamethod_name" type="AN" maxsize="32" minnum="0" />
+            <DE name="zkamethod_version" type="AN" maxsize="10" minnum="0" />
+            <DE name="name" type="AN" maxsize="30"/>
+            <DE name="maxlentan2step" type="Num" maxsize="2"/>
+            <DE name="tanformat" type="Code" maxsize="1"/>
+            <DE name="inputinfo" type="AN" maxsize="30"/>
+            <DE name="maxleninput2step" type="Num" maxsize="4"/>
+            <DE name="noftanlists" type="Num" maxsize="1" minnum="0"/>
+            <DE name="canmultitan" type="JN"/>
+            <DE name="cantandelay" type="Code" maxsize="1"/>
+            <DE name="needtanlistidx" type="Code" maxsize="1"/>
+            <DE name="canstorno" type="JN"/>
+            <DE name="needsmsaccount" type="Code" maxsize="1"/>
+            <DE name="needorderaccount" type="Code" maxsize="1"/>
+            <DE name="needchallengeklass" type="JN"/>
+            <DE name="ischallengestructured" type="JN" />
+            <DE name="initmode" type="Code"/>
+            <DE name="needtanmedia" type="Code"/>
+            <DE name="nofactivetanmedia" type="Num" maxsize="1" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+            <valids path="tanformat">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="TANInfo">
             <DE name="usagecode" type="Code" maxsize="2"/>
             <DE name="usagetxt" type="AN" maxsize="99" minnum="0"/>
@@ -4608,6 +4655,67 @@
             <value path="SegHead.version">4</value>
         </SEGdef>
 
+
+        <!--  willuhn 2011-05-16 BEGIN HKTAN/HITAN/HITANS Version 5 -->
+        <SEGdef id="TAN2Step5" needsRequestTag="1">
+            <DEG type="SegHeadUser" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="ordersegcode" type="AN" maxsize="6" minnum="0"/>
+            <DEG name="OrderAccount" type="KTV3" minnum="0" />
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="notlasttan" type="JN" minnum="0"/>
+            <DE name="storno" type="JN" minnum="0"/>
+            <DEG name="SMSAccount" type="KTV3" minnum="0" />
+            <DE name="challengeklass" type="Num" maxsize="2" minnum="0"/>
+            <DEG type="ChallengeKlassParams" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HKTAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepRes5">
+            <DEG type="SegHeadInst" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="challenge" type="AN" maxsize="2048" minnum="0"/>
+            <DE name="challenge_hhd_uc" type="Bin" maxsize="0" minnum="0" />
+            <DEG type="ChallengeValidity" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="ben" type="AN" maxsize="99" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HITAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepPar5">
+            &GVP2;
+            <DEG type="ParTAN2Step5" name="ParTAN2Step"/>
+            
+            &SecClassValids;
+            
+            <value path="SegHead.code">HITANS</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <!--  willuhn 2011-05-16 END HKTAN/HITAN/HITANS Version 5 -->
+
+
         <SEGdef id="TANListList1" needsRequestTag="1"> <!-- 2.2 -->
             <DEG type="SegHeadUser" name="SegHead"/>
 
@@ -6230,6 +6338,7 @@
             <SEG type="TAN2Step2" minnum="0"/>
             <SEG type="TAN2Step3" minnum="0"/>
             <SEG type="TAN2Step4" minnum="0"/>
+            <SEG type="TAN2Step5" minnum="0"/>
             <SEG type="TANListList1" minnum="0"/>
             <SEG type="TermSammelLast3" minnum="0"/>
             <SEG type="TermSammelLastDel3" minnum="0"/>
@@ -6348,6 +6457,7 @@
             <SEG type="TAN2StepRes2" minnum="0"/>
             <SEG type="TAN2StepRes3" minnum="0"/>
             <SEG type="TAN2StepRes4" minnum="0"/>
+            <SEG type="TAN2StepRes5" minnum="0"/>
             <SEG type="TANListListRes1" minnum="0"/>
             <SEG type="TermSammelLastRes3" minnum="0"/>
             <SEG type="TermSammelLastListRes3" minnum="0"/>
@@ -6480,6 +6590,7 @@
             <SEG type="TAN2StepPar2" minnum="0"/>
             <SEG type="TAN2StepPar3" minnum="0"/>
             <SEG type="TAN2StepPar4" minnum="0"/>
+            <SEG type="TAN2StepPar5" minnum="0"/>
             <SEG type="TANListListPar1" minnum="0"/>
             <SEG type="TermSammelLastPar3" minnum="0"/>
             <SEG type="TermSammelLastDelPar3" minnum="0"/>
Index: src/hbci-plus.xml
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/hbci-plus.xml,v
retrieving revision 1.1
diff -u -r1.1 hbci-plus.xml
--- src/hbci-plus.xml	4 May 2011 22:37:50 -0000	1.1
+++ src/hbci-plus.xml	17 May 2011 16:37:52 -0000
@@ -1248,7 +1248,20 @@
                 <validvalue>2</validvalue>
             </valids>
         </DEGdef>
-        
+
+        <DEGdef id="ParTAN2Step5">
+            <DE name="can1step" type="JN"/>
+            <DE name="canmultitangvs" type="JN"/>
+            <DE name="orderhashmode" type="Code" maxsize="1"/>
+            <DEG type="TAN2StepParams5" name="TAN2StepParams" maxnum="98"/>
+            
+            <valids path="orderhashmode">
+                <validvalue>0</validvalue>
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="ParTemplateD">
             <DE name="dummy" type="AN" minsize="0" maxsize="999" minnum="2" maxnum="999"/>
         </DEGdef>
@@ -1518,6 +1531,40 @@
             </valids>
         </DEGdef>
 
+        <DEGdef id="TAN2StepParams5">
+            <DE name="secfunc" type="Code" maxsize="3"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="id" type="ID"/>
+            <DE name="zkamethod_name" type="AN" maxsize="32" minnum="0" />
+            <DE name="zkamethod_version" type="AN" maxsize="10" minnum="0" />
+            <DE name="name" type="AN" maxsize="30"/>
+            <DE name="maxlentan2step" type="Num" maxsize="2"/>
+            <DE name="tanformat" type="Code" maxsize="1"/>
+            <DE name="inputinfo" type="AN" maxsize="30"/>
+            <DE name="maxleninput2step" type="Num" maxsize="4"/>
+            <DE name="noftanlists" type="Num" maxsize="1" minnum="0"/>
+            <DE name="canmultitan" type="JN"/>
+            <DE name="cantandelay" type="Code" maxsize="1"/>
+            <DE name="needtanlistidx" type="Code" maxsize="1"/>
+            <DE name="canstorno" type="JN"/>
+            <DE name="needsmsaccount" type="Code" maxsize="1"/>
+            <DE name="needorderaccount" type="Code" maxsize="1"/>
+            <DE name="needchallengeklass" type="JN"/>
+            <DE name="ischallengestructured" type="JN" />
+            <DE name="initmode" type="Code"/>
+            <DE name="needtanmedia" type="Code"/>
+            <DE name="nofactivetanmedia" type="Num" maxsize="1" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+            <valids path="tanformat">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+            </valids>
+        </DEGdef>
+
         <DEGdef id="TANInfo">
             <DE name="usagecode" type="Code" maxsize="2"/>
             <DE name="usagetxt" type="AN" maxsize="99" minnum="0"/>
@@ -4482,6 +4529,72 @@
             <value path="SegHead.version">4</value>
         </SEGdef>
 
+
+
+
+        <!--  willuhn 2011-05-16 BEGIN HKTAN/HITAN/HITANS Version 5 -->
+        <SEGdef id="TAN2Step5" needsRequestTag="1">
+            <DEG type="SegHeadUser" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="ordersegcode" type="AN" maxsize="6" minnum="0"/>
+            <DEG name="OrderAccount" type="KTV3" minnum="0" />
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="notlasttan" type="JN" minnum="0"/>
+            <DE name="storno" type="JN" minnum="0"/>
+            <DEG name="SMSAccount" type="KTV3" minnum="0" />
+            <DE name="challengeklass" type="Num" maxsize="2" minnum="0"/>
+            <DEG type="ChallengeKlassParams" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HKTAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepRes5">
+            <DEG type="SegHeadInst" name="SegHead"/>
+            <DE name="process" type="Code" maxsize="1"/>
+            <DE name="orderhash" type="Bin" maxsize="256" minnum="0"/>
+            <DE name="orderref" type="AN" maxsize="35" minnum="0"/>
+            <DE name="challenge" type="AN" maxsize="2048" minnum="0"/>
+            <DE name="challenge_hhd_uc" type="Bin" maxsize="0" minnum="0" />
+            <DEG type="ChallengeValidity" minnum="0"/>
+            <DE name="listidx" type="AN" maxsize="20" minnum="0"/>
+            <DE name="ben" type="AN" maxsize="99" minnum="0"/>
+            <DE name="tanmedia" type="AN" maxsize="32" minnum="0"/>
+            
+            <valids path="process">
+                <validvalue>1</validvalue>
+                <validvalue>2</validvalue>
+                <validvalue>3</validvalue>
+                <validvalue>4</validvalue>
+            </valids>
+            
+            <value path="SegHead.code">HITAN</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <SEGdef id="TAN2StepPar5">
+            &GVP2;
+            <DEG type="ParTAN2Step5" name="ParTAN2Step"/>
+            
+            &SecClassValids;
+            
+            <value path="SegHead.code">HITANS</value>
+            <value path="SegHead.version">5</value>
+        </SEGdef>
+        <!--  willuhn 2011-05-16 END HKTAN/HITAN/HITANS Version 5 -->
+
+
+
+
+
         <SEGdef id="TANListList1" needsRequestTag="1"> <!-- 2.2 -->
             <DEG type="SegHeadUser" name="SegHead"/>
 
@@ -6100,6 +6213,7 @@
             <SEG type="TAN2Step2" minnum="0"/>
             <SEG type="TAN2Step3" minnum="0"/>
             <SEG type="TAN2Step4" minnum="0"/>
+            <SEG type="TAN2Step5" minnum="0"/>
             <SEG type="TANListList1" minnum="0"/>
             <SEG type="TermSammelLast3" minnum="0"/>
             <SEG type="TermSammelLastDel3" minnum="0"/>
@@ -6218,6 +6332,7 @@
             <SEG type="TAN2StepRes2" minnum="0"/>
             <SEG type="TAN2StepRes3" minnum="0"/>
             <SEG type="TAN2StepRes4" minnum="0"/>
+            <SEG type="TAN2StepRes5" minnum="0"/>
             <SEG type="TANListListRes1" minnum="0"/>
             <SEG type="TermSammelLastRes3" minnum="0"/>
             <SEG type="TermSammelLastListRes3" minnum="0"/>
@@ -6350,6 +6465,7 @@
             <SEG type="TAN2StepPar2" minnum="0"/>
             <SEG type="TAN2StepPar3" minnum="0"/>
             <SEG type="TAN2StepPar4" minnum="0"/>
+            <SEG type="TAN2StepPar5" minnum="0"/>
             <SEG type="TANListListPar1" minnum="0"/>
             <SEG type="TermSammelLastPar3" minnum="0"/>
             <SEG type="TermSammelLastDelPar3" minnum="0"/>
Index: src/org/kapott/hbci/GV/AbstractMultiGV.java
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/org/kapott/hbci/GV/AbstractMultiGV.java,v
retrieving revision 1.1
diff -u -r1.1 AbstractMultiGV.java
--- src/org/kapott/hbci/GV/AbstractMultiGV.java	4 May 2011 22:37:53 -0000	1.1
+++ src/org/kapott/hbci/GV/AbstractMultiGV.java	17 May 2011 16:37:52 -0000
@@ -75,6 +75,11 @@
             } else if (path.equals("sumCurr")) {
             	// whrung des sammlers
                 ret=dtaus.getCurr()==DTAUS.CURR_DM?"DEM":"EUR";
+            
+            } else if (path.equals("sumCount")) {
+              // willuhn 2011-05-17 Anzahl der Buchungen, HHD 1.4
+              // Anzahl der Buchungen
+              ret = Integer.toString(dtaus.getEntries().size());
             }
         } else {
             ret=super.getChallengeParam(path);
Index: src/org/kapott/hbci/GV/GVTAN2Step.java
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/org/kapott/hbci/GV/GVTAN2Step.java,v
retrieving revision 1.3
diff -u -r1.3 GVTAN2Step.java
--- src/org/kapott/hbci/GV/GVTAN2Step.java	13 May 2011 15:31:38 -0000	1.3
+++ src/org/kapott/hbci/GV/GVTAN2Step.java	17 May 2011 16:37:53 -0000
@@ -68,6 +68,19 @@
         addConstraint("ChallengeKlassParam9", "ChallengeKlassParams.param_9","", LogFilter.FILTER_IDS);
 
         addConstraint("tanmedia", "tanmedia","", LogFilter.FILTER_IDS);
+
+        addConstraint("ordersegcode", "ordersegcode","", LogFilter.FILTER_NONE);
+
+        addConstraint("orderaccount.number","OrderAccount.number",null, LogFilter.FILTER_IDS);
+        addConstraint("orderaccount.subnumber","OrderAccount.subnumber","", LogFilter.FILTER_MOST);
+        addConstraint("orderaccount.blz","OrderAccount.KIK.blz",null, LogFilter.FILTER_MOST);
+        addConstraint("orderaccount.country","OrderAccount.KIK.country","DE", LogFilter.FILTER_NONE);
+
+        // willuhn 2011-05-17 wird noch nicht genutzt
+        // addConstraint("smsaccount.number","SMSAccount.number",null, LogFilter.FILTER_IDS);
+        // addConstraint("smsaccount.subnumber","SMSAccount.subnumber","", LogFilter.FILTER_MOST);
+        // addConstraint("smsaccount.blz","SMSAccount.KIK.blz",null, LogFilter.FILTER_MOST);
+        // addConstraint("smsaccount.country","SMSAccount.KIK.country","DE", LogFilter.FILTER_NONE);
     }
     
     public void setParam(String paramName, String value)
Index: src/org/kapott/hbci/GV/HBCIJobImpl.java
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/org/kapott/hbci/GV/HBCIJobImpl.java,v
retrieving revision 1.1
diff -u -r1.1 HBCIJobImpl.java
--- src/org/kapott/hbci/GV/HBCIJobImpl.java	4 May 2011 22:37:54 -0000	1.1
+++ src/org/kapott/hbci/GV/HBCIJobImpl.java	17 May 2011 16:37:53 -0000
@@ -931,6 +931,32 @@
         return result;
     }
     
+    /**
+     * Liefert das Auftraggeber-Konto, wie es ab HKTAN5 erforderlich ist.
+     * @return das Auftraggeber-Konto oder NULL, wenn keines angegeben ist.
+     */
+    public Konto getOrderAccount()
+    {
+      // Checken, ob wir das Konto unter "My.number" haben
+      String prefix = this.getName() + ".My.";
+      String number = this.getLowlevelParam(prefix + "number");
+      if (number == null || number.length() == 0)
+      {
+        // OK, vielleicht unter "KTV.number"?
+        prefix = this.getName() + ".KTV.";
+        number = this.getLowlevelParam(prefix + "number");
+
+        if (number == null || number.length() == 0)
+          return null; // definitiv kein Konto vorhanden
+      }
+      Konto k = new Konto();
+      k.number    = number;
+      k.subnumber = this.getLowlevelParam(prefix + "subnumber");
+      k.blz       = this.getLowlevelParam(prefix + "KIK.blz");
+      k.country   = this.getLowlevelParam(prefix + "KIK.country");
+      return k;
+    }
+    
     public HBCIHandler getParentHandler()
     {
         return this.parentHandler;
Index: src/org/kapott/hbci/manager/ChallengeInfo.java
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/org/kapott/hbci/manager/ChallengeInfo.java,v
retrieving revision 1.3
diff -u -r1.3 ChallengeInfo.java
--- src/org/kapott/hbci/manager/ChallengeInfo.java	16 May 2011 15:40:00 -0000	1.3
+++ src/org/kapott/hbci/manager/ChallengeInfo.java	17 May 2011 16:37:53 -0000
@@ -1,191 +1,423 @@
-
 /*  $Id: 14-hbci4java-hktan5-hhd14.patch,v 1.1 2011/05/17 16:39:17 willuhn Exp $
 
-    This file is part of HBCI4Java
-    Copyright (C) 2001-2008  Stefan Palme
+ This file is part of HBCI4Java
+ Copyright (C) 2001-2008  Stefan Palme
 
-    HBCI4Java is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; either version 2 of the License, or
-    (at your option) any later version.
-
-    HBCI4Java is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
+ HBCI4Java is free software; you can redistribute it and/or modify
+ it under the terms of the GNU General Public License as published by
+ the Free Software Foundation; either version 2 of the License, or
+ (at your option) any later version.
+
+ HBCI4Java is distributed in the hope that it will be useful,
+ but WITHOUT ANY WARRANTY; without even the implied warranty of
+ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ GNU General Public License for more details.
+
+ You should have received a copy of the GNU General Public License
+ along with this program; if not, write to the Free Software
+ Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
 
 package org.kapott.hbci.manager;
 
 import java.io.InputStream;
 import java.util.ArrayList;
-import java.util.Hashtable;
+import java.util.HashMap;
 import java.util.List;
+import java.util.Map;
+import java.util.Properties;
 
 import javax.xml.parsers.DocumentBuilder;
 import javax.xml.parsers.DocumentBuilderFactory;
 
+import org.kapott.hbci.GV.HBCIJob;
+import org.kapott.hbci.GV.HBCIJobImpl;
+import org.kapott.hbci.datatypes.SyntaxWrt;
 import org.kapott.hbci.exceptions.HBCI_Exception;
 import org.kapott.hbci.exceptions.InvalidUserDataException;
 import org.w3c.dom.Document;
 import org.w3c.dom.Element;
+import org.w3c.dom.Node;
 import org.w3c.dom.NodeList;
 
-//TODO: doku fehlt
-public class ChallengeInfo 
+/**
+ * Diese Klasse ermittelt die noetigen HKTAN-Challenge-Parameter fuer einen
+ * Geschaeftsvorfall
+ */
+public class ChallengeInfo
 {
-    private static ChallengeInfo _instance=null;
+  /**
+   * Versionskennung fuer HHD 1.2
+   */
+  public final static String VERSION_HHD_1_2 = "hhd12";
+  
+  /**
+   * Versionskennung fuer HHD 1.3
+   */
+  public final static String VERSION_HHD_1_3 = "hhd13";
+
+  /**
+   * Versionskennung fuer HHD 1.4
+   */
+  public final static String VERSION_HHD_1_4 = "hhd14";
+
+  /**
+   * Das Singleton.
+   */
+  private static ChallengeInfo singleton = null;
+    private Map<String,Job> data = null; // Die Parameter-Daten aus der XML-Datei.
+
+  /**
+   * Erzeugt ein neues Challenge-Info-Objekt.
+   * @return das Challenge-Info-Objekt.
+   */
+  public static synchronized ChallengeInfo getInstance()
+  {
+    if (singleton == null)
+      singleton = new ChallengeInfo();
+    return singleton;
+  }
+  
+  /**
+   * ct.
+   */
+  private ChallengeInfo()
+  {
+    HBCIUtils.log("initializing challenge info engine",HBCIUtils.LOG_DEBUG);
+
+    
+    ////////////////////////////////////////////////////////////////////////////
+    // XML-Datei lesen
+    String xmlpath = HBCIUtils.getParam("kernel.kernel.challengedatapath","");
+    InputStream dataStream = null;
+
+    String filename = xmlpath+"challengedata.xml";
+    dataStream = ChallengeInfo.class.getClassLoader().getResourceAsStream(filename);
+    if (dataStream == null)
+      throw new InvalidUserDataException("*** can not load challenge information from "+filename);
+
+    // mit den so gefundenen xml-daten ein xml-dokument bauen
+    Document doc = null;
+    try
+    {
+      DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
+      dbf.setIgnoringComments(true);
+      dbf.setValidating(true);
+
+      DocumentBuilder db = dbf.newDocumentBuilder();
+      doc = db.parse(dataStream);
+      dataStream.close();
+    }
+    catch (Exception e)
+    {
+      throw new HBCI_Exception("*** can not load challengedata from file "+filename,e);
+    }
+    //
+    ////////////////////////////////////////////////////////////////////////////
+
+    data = new HashMap<String,Job>();
+
+    ////////////////////////////////////////////////////////////////////////////
+    // Parsen
+    NodeList jobs = doc.getElementsByTagName("job");
+    int size      = jobs.getLength();
+    
+    for (int i=0;i<size;++i)
+    {
+      Element job = (Element) jobs.item(i);
+      String code = job.getAttribute("code");
+      data.put(code,new Job(job));
+    }
+    //
+    ////////////////////////////////////////////////////////////////////////////
+
+    HBCIUtils.log("challenge information loaded",HBCIUtils.LOG_DEBUG);
+  }
+  
+  /**
+   * Ermittelt die zu verwendende HHD-Version aus den BPD-Informationen des TAN-Verfahrens.
+   * @param secmech die BPD-Informationen zum TAN-Verfahren.
+   * @return die HHD-Version.
+   */
+  private String getVersion(Properties secmech)
+  {
+    // HHD-Version ermitteln
+    String id = secmech.getProperty("id","");
+    
+    if (id.startsWith("HHD1.4")) return VERSION_HHD_1_4;
+    if (id.startsWith("HHD1.3")) return VERSION_HHD_1_3;
+    
+    // Default:
+    return VERSION_HHD_1_2;
+  }
+  
+  /**
+   * Liefert die Challenge-Daten fuer einen Geschaeftsvorfall.
+   * @param code die Segmentkennung des Geschaeftsvorfalls.
+   * @return die Challenge-Daten.
+   */
+  public Job getData(String code)
+  {
+    return data.get(code);
+  }
+
+  /**
+   * Uebernimmt die Challenge-Parameter in den HKTAN-Geschaeftsvorfall.
+   * @param task der Job, zu dem die Challenge-Parameter ermittelt werden sollen.
+   * @param hktan der HKTAN-Geschaeftsvorfall, in dem die Parameter gesetzt werden sollen.
+   * @param secmech die BPD-Informationen zum TAN-Verfahren.
+   */
+  public void applyParams(HBCIJobImpl task, HBCIJob hktan, Properties secmech)
+  {
+    String code = task.getHBCICode(); // Code des Geschaeftsvorfalls
+
+    // Job-Parameter holen
+    Job job = this.getData(code);
+    
+    // Den Geschaeftsvorfall kennen wir nicht. Dann brauchen wir
+    // auch keine Challenge-Parameter setzen
+    if (job == null)
+    {
+      HBCIUtils.log("have no challenge data for " + code + ", will not apply challenge params", HBCIUtils.LOG_INFO);
+      return;
+    }
+    
+    String version = this.getVersion(secmech); // HHD-Version
+    HBCIUtils.log("using hhd version " + version, HBCIUtils.LOG_DEBUG2);
+
+    // Parameter fuer die passende HHD-Version holen
+    HhdVersion hhd = job.getVersion(version);
+    
+    // Wir haben keine Parameter fuer diese HHD-Version
+    if (hhd == null)
+    {
+      HBCIUtils.log("have no challenge data for " + code + " in " + version + ", will not apply challenge params", HBCIUtils.LOG_INFO);
+      return;
+    }
 
-    private Hashtable challengedata;
 
-    static public ChallengeInfo getInstance()
+    // Schritt 1: Challenge-Klasse uebernehmen
+    String klass = hhd.getKlass();
+    HBCIUtils.log("using challenge klass " + klass, HBCIUtils.LOG_DEBUG2);
+    hktan.setParam("challengeklass", klass);
+
+    
+    // Schritt 2: Challenge-Parameter uebernehmen
+    List<Param> params = hhd.getParams();
+    for (int i=0;i<params.size();++i)
+    {
+      int num = i+1; // Die Job-Parameter beginnen bei 1
+      Param param = params.get(i);
+      
+      // Checken, ob der Parameter angewendet werden soll.
+      if (!param.isComplied(secmech))
+      {
+        HBCIUtils.log("skipping challenge parameter " + num + " (" + param.path + "), condition " + param.conditionName + "=" + param.conditionValue + " not complied",HBCIUtils.LOG_DEBUG2);
+        continue;
+      }
+      
+      // Parameter uebernehmen. Aber nur wenn er auch einen Wert hat.
+      // Seit HHD 1.4 duerfen Parameter mittendrin optional sein, sie
+      // werden dann freigelassen
+      String value = param.getValue(task);
+      
+      if (value == null || value.length() == 0)
+      {
+        HBCIUtils.log("challenge parameter " + num + " (" + param.path + ") is empty",HBCIUtils.LOG_DEBUG2);
+        continue;
+      }
+      
+      HBCIUtils.log("adding challenge parameter " + num + " " + param.path + "=" + value, HBCIUtils.LOG_DEBUG2);
+      hktan.setParam("ChallengeKlassParam" + num, value);
+    }
+  }
+  
+  /**
+   * Eine Bean fuer die Parameter-Saetze eines Geschaeftsvorfalles fuer die HHD-Versionen.
+   */
+  public static class Job
+  {
+    /**
+     * Die Parameter fuer die jeweilige HHD-Version.
+     */
+    private Map<String,HhdVersion> versions = new HashMap<String,HhdVersion>();
+    
+    /**
+     * ct.
+     * @param job der XML-Knoten, in dem die Daten stehen.
+     */
+    private Job(Element job)
+    {
+      NodeList specs = job.getElementsByTagName("challengeinfo");
+      int size       = specs.getLength();
+      
+      for (int i=0;i<size;++i)
+      {
+        Element spec    = (Element) specs.item(i);
+        String  version = spec.getAttribute("spec");
+        
+        this.versions.put(version,new HhdVersion(spec));
+      }
+    }
+    
+    /**
+     * Liefert die Challenge-Parameter fuer die angegeben HHD-Version.
+     * @param version die HHD-Version.
+     * @return die Challenge-Parameter fuer die HHD-Version.
+     */
+    public HhdVersion getVersion(String version)
+    {
+      return this.versions.get(version);
+    }
+  }
+  
+  /**
+   * Eine Bean fuer den Parameter-Satz eines Geschaeftvorfalles innerhalb einer HHD-Version.
+   */
+  public static class HhdVersion
+  {
+    /**
+     * Die Challenge-Klasse.
+     */
+    private String klass = null;
+    
+    /**
+     * Liste der Challenge-Parameter.
+     */
+    private List<Param> params = new ArrayList<Param>();
+    
+    /**
+     * ct.
+     * @param spec der XML-Knoten mit den Daten.
+     */
+    private HhdVersion(Element spec)
+    {
+      this.klass = ((Element)spec.getElementsByTagName("klass").item(0)).getFirstChild().getNodeValue();
+
+      NodeList list = spec.getElementsByTagName("param");
+      int size      = list.getLength();
+      for (int i=0;i<size;++i)
+      {
+        Element param = (Element) list.item(i);
+        this.params.add(new Param(param));
+      }
+    }
+    
+    /**
+     * Liefert die Challenge-Klasse.
+     * @return die Challenge-Klasse.
+     */
+    public String getKlass()
+    {
+      return this.klass;
+    }
+    
+    /**
+     * Liefert die Challenge-Parameter fuer den Geschaeftsvorfall in dieser HHD-Version.
+     * @return die Challenge-Parameter fuer den Geschaeftsvorfall in dieser HHD-Version.
+     */
+    public List<Param> getParams()
+    {
+      return this.params;
+    }
+  }
+  
+  /**
+   * Eine Bean fuer einen einzelnen Challenge-Parameter.
+   */
+  public static class Param
+  {
+    /**
+     * Der Typ des Parameters.
+     */
+    private String type = null;
+    
+    /**
+     * Der Pfad in den Geschaeftsvorfall-Parametern, unter dem der Wert steht.
+     */
+    private String path = null;
+    
+    /**
+     * Optional: Der Name einer Bedingung, die erfuellt sein muss, damit
+     * der Parameter verwendet wird. Konkret ist hier der Name eines Property
+     * aus secmechInfo gemeint. Also ein BPD-Parameter.
+     */
+    private String conditionName = null;
+    
+    /**
+     * Optional: Der Wert, den der BPD-Parameter haben muss, damit der Challenge-Parameter
+     * verwendet wird.
+     */
+    private String conditionValue = null;
+    
+    /**
+     * ct.
+     * @param param der XML-Knoten mit den Daten.
+     */
+    private Param(Element param)
+    {
+      Node content = param.getFirstChild();
+      this.path           = content != null ? content.getNodeValue() : null;
+      this.type           = param.getAttribute("type");
+      this.conditionName  = param.getAttribute("condition-name");
+      this.conditionValue = param.getAttribute("condition-value");
+    }
+    
+    /**
+     * Liefert true, wenn entweder keine Bedingung angegeben ist oder
+     * die Bedingung erfuellt ist und der Parameter verwendet werden kann.
+     * @param secmech die BPD-Informationen zum TAN-Verfahren.
+     * @return true, wenn der Parameter verwendet werden kann.
+     */
+    public boolean isComplied(Properties secmech)
+    {
+      if (this.conditionName == null || this.conditionName.length() == 0)
+        return true;
+      
+      // Wir haben eine Bedingung. Mal schauen, ob sie erfuellt ist.
+      String value = secmech.getProperty(this.conditionName,"");
+      return value.equals(this.conditionValue);
+    }
+    
+    /**
+     * Liefert den Typ des Parameters.
+     * @return der Typ des Parameters.
+     */
+    public String getType()
+    {
+      return this.type;
+    }
+    
+    /**
+     * Liefert den Pfad zum Wert.
+     * @return der Pfad zum Wert.
+     */
+    public String getPath()
+    {
+      return this.path;
+    }
+    
+    /**
+     * Liefert den Wert des Parameters.
+     * @param job der Geschaeftsvorfall.
+     * @return der Wert des Parameters.
+     */
+    private String getValue(HBCIJobImpl job)
     {
-        if (_instance==null) {
-            _instance=new ChallengeInfo();
-        }
-        return _instance;
-    }
-
-    private ChallengeInfo()
-    {
-        HBCIUtils.log("initializing challenge info engine",HBCIUtils.LOG_DEBUG);
-
-        // classloader ermitteln, mit dem die challengedata.xml geladen werden soll
-        ClassLoader cl=this.getClass().getClassLoader();
-
-        // versuchen, die challengeinfo.xml mit diesem classloader zu laden
-        String xmlpath=HBCIUtils.getParam("kernel.kernel.challengedatapath");
-        InputStream dataStream=null;
-        if (xmlpath==null) {
-            xmlpath="";
-        }
-
-        String filename=xmlpath+"challengedata.xml";
-        dataStream=cl.getResourceAsStream(filename);
-        if (dataStream==null)
-            throw new InvalidUserDataException("*** can not load challenge information from "+filename);
-
-        // mit den so gefundenen xml-daten ein xml-dokument bauen
-        Document doc=null;
-        try {
-            DocumentBuilderFactory dbf=DocumentBuilderFactory.newInstance();
-
-            dbf.setIgnoringComments(true);
-            dbf.setValidating(true);
-
-            DocumentBuilder db=dbf.newDocumentBuilder();
-            doc=db.parse(dataStream);
-            dataStream.close();
-        } catch (Exception e) {
-            throw new HBCI_Exception("*** can not load challengedata from file "+filename,e);
-        }
-
-        // dieses xml-dokument parsen und daraus ein entsprechendes properties
-        // objekt mit den challenge-informationen machen
-        this.challengedata=new Hashtable();
-
-        NodeList jobs=doc.getElementsByTagName("job");
-        int      jobs_len=jobs.getLength();
-        for (int j=0;j<jobs_len;j++) {
-            Element    job=(Element)jobs.item(j);
-            String     segcode=job.getAttribute("code");
-
-            Hashtable h_specs=new Hashtable();
-            challengedata.put(segcode,h_specs);
-
-            NodeList specs=job.getElementsByTagName("challengeinfo");
-            int      specs_len=specs.getLength();
-            for (int s=0;s<specs_len;s++) {
-                Element spec=(Element)specs.item(s);
-                String  specname=spec.getAttribute("spec");
-
-                Hashtable h_info=new Hashtable();
-                h_specs.put(specname,h_info);
-
-                h_info.put("klass", ((Element)spec.getElementsByTagName("klass").item(0)).getFirstChild().getNodeValue());
-
-                NodeList params=spec.getElementsByTagName("param");
-                int      params_len=params.getLength();
-                
-                // jetzt alle params durchgehen und merken 
-                List     params_l=new ArrayList();
-                for (int p=0;p<params_len;p++) {
-                    Element param=(Element)params.item(p);
-                    params_l.add(param.getFirstChild().getNodeValue());
-                }
-                h_info.put("param_paths", params_l.toArray(new String[params_len]));
-
-                // das gleiche fr value
-                NodeList values=spec.getElementsByTagName("value");
-                if (values.getLength()!=0) {
-                    h_info.put("value_path", values.item(0).getFirstChild().getNodeValue());
-                }
-
-                // und fr curr
-                NodeList currs=spec.getElementsByTagName("curr");
-                if (currs.getLength()!=0) {
-                    h_info.put("curr_path", currs.item(0).getFirstChild().getNodeValue());
-                }
-            }
-        }
-
-        HBCIUtils.log("challenge information loaded",HBCIUtils.LOG_DEBUG);
-    }
-
-    public Hashtable getInfoBySegCode(String segcode,String spec)
-    {
-        Hashtable result=null;
-        Hashtable specs_table=(Hashtable)(this.challengedata.get(segcode));
-        if (specs_table!=null) {
-            result=(Hashtable)specs_table.get(spec);
-        }
-        return result;
-    }
-
-    public String getKlassBySegCode(String segcode,String spec)
-    {
-        String    klass=null;
-        Hashtable info=getInfoBySegCode(segcode,spec);
-        if (info!=null) {
-            klass=(String)info.get("klass");
-        }
-        return klass;
-    }
-
-    public String[] getParamPathsBySegCode(String segcode,String spec)
-    {
-        String[]  parampaths=new String[0];
-        Hashtable info=getInfoBySegCode(segcode,spec);
-        if (info!=null) {
-            String[] paths=(String[])info.get("param_paths");
-            if (paths!=null) {
-                parampaths=paths;
-            }
-        }
-        return parampaths;
-    }
-
-    public String getValuePathBySegCode(String segcode,String spec)
-    {
-        String    valuepath=null;
-        Hashtable info=getInfoBySegCode(segcode,spec);
-        if (info!=null) {
-            valuepath=(String)info.get("value_path");
-        }
-        return valuepath;
-    }
-
-    public String getCurrPathBySegCode(String segcode,String spec)
-    {
-        String    currpath=null;
-        Hashtable info=getInfoBySegCode(segcode,spec);
-        if (info!=null) {
-            currpath=(String)info.get("curr_path");
-        }
-        return currpath;
+      // Leerer Parameter
+      if (this.path == null || this.path.length() == 0)
+        return null;
+      
+      String value = job.getChallengeParam(this.path);
+      if (value == null || value.length() == 0)
+        return value;
+
+      // Ist es ein Betrag?
+      if (type != null && type.equals("value"))
+        return new SyntaxWrt(value, 1, 0).toString(0);
+      
+      // Ansonsten ganz normal den Betrag zurueckliefern
+      return value;
     }
+  }
 }
Index: src/org/kapott/hbci/passport/AbstractPinTanPassport.java
===================================================================
RCS file: /cvsroot/hibiscus/hbci4java/src/org/kapott/hbci/passport/AbstractPinTanPassport.java,v
retrieving revision 1.3
diff -u -r1.3 AbstractPinTanPassport.java
--- src/org/kapott/hbci/passport/AbstractPinTanPassport.java	13 May 2011 15:26:23 -0000	1.3
+++ src/org/kapott/hbci/passport/AbstractPinTanPassport.java	17 May 2011 16:37:54 -0000
@@ -35,7 +35,6 @@
 import org.kapott.hbci.GV.HBCIJobImpl;
 import org.kapott.hbci.callback.HBCICallback;
 import org.kapott.hbci.comm.Comm;
-import org.kapott.hbci.datatypes.SyntaxWrt;
 import org.kapott.hbci.exceptions.HBCI_Exception;
 import org.kapott.hbci.exceptions.InvalidUserDataException;
 import org.kapott.hbci.manager.ChallengeInfo;
@@ -44,13 +43,13 @@
 import org.kapott.hbci.manager.HBCIKey;
 import org.kapott.hbci.manager.HBCIUtils;
 import org.kapott.hbci.manager.HBCIUtilsInternal;
-import org.kapott.hbci.manager.LogFilter;
 import org.kapott.hbci.protocol.SEG;
 import org.kapott.hbci.protocol.factory.SEGFactory;
 import org.kapott.hbci.security.Crypt;
 import org.kapott.hbci.security.Sig;
 import org.kapott.hbci.status.HBCIMsgStatus;
 import org.kapott.hbci.status.HBCIRetVal;
+import org.kapott.hbci.structures.Konto;
 
 public abstract class AbstractPinTanPassport 
     extends AbstractHBCIPassport
@@ -959,6 +958,31 @@
                             HBCIJob hktan=handler.newJob("TAN2Step");
                             hktan.setParam("process",process);
                             hktan.setParam("notlasttan","N");
+                            
+                            // willuhn 2011-05-16
+                            // Siehe FinTS_3.0_Security_Sicherheitsverfahren_PINTAN_Rel_20101027_final_version.pdf, Seite 58
+                            int hktanVersion = Integer.parseInt(hktan.getSegVersion());
+                            if (hktanVersion >= 5)
+                            {
+                              // Bis HKTAN4/hhd1.3 wurde das noch als Challenge-Parameter uebermittelt. Jetzt hat es einen
+                              // eigenen Platz in den Job-Parametern
+                              hktan.setParam("ordersegcode",task.getHBCICode());
+
+                              // Zitat aus HITANS5: Diese Funktion ermglicht das Sicherstellen einer gltigen Kontoverbindung
+                              // z. B. fr die Abrechnung von SMS-Kosten bereits vor Erzeugen und Versenden einer
+                              // (ggf. kostenpflichtigen!) TAN.
+                              //  0: Auftraggeberkonto darf nicht angegeben werden
+                              //  2: Auftraggeberkonto muss angegeben werden, wenn im Geschftsvorfall enthalten
+                              if (secmechInfo.getProperty("needorderaccount","").equals("2"))
+                              {
+                                Konto k = task.getOrderAccount();
+                                if (k != null)
+                                  hktan.setParam("orderaccount",k);
+                                else
+                                  HBCIUtils.log("orderaccount needed, but not found in " + task.getHBCICode(),HBCIUtils.LOG_DEBUG);
+                              }
+                            }
+                            
                             // TODO: das fr mehrfachsignaturen
                             // hktan.setParam("notlasttan","J");
                             
@@ -996,78 +1020,15 @@
                             // hktan.setParam("listidx","");
                             
                             // wenn needchallengeklass gesetzt ist:
-                            if (secmechInfo.getProperty("needchallengeklass","N").equals("J")) {
-                                HBCIUtils.log("we are in PV #1, and a challenge klass is required",
-                                                HBCIUtils.LOG_DEBUG);
-                                ChallengeInfo cinfo=ChallengeInfo.getInstance();
-                                
-                                // TODO: verwendete spezifikation parametrisieren
-                                int    hktan_version=Integer.parseInt(hktan.getSegVersion());
-                                String spec=hktan_version<3?"hhd12":"hhd13";
-
-                                // TODO: willuhn 2011-05-13 Woran kann ich festmachen, welche HHD-Version verwendet werden soll?
-                                // FinTS_3.0_Security_Sicherheitsverfahren_PINTAN_Rel_20101027_final_version.pdf, Kapitel B.4.5
-                                // klingt so, als wuerde hhd14 ab HKTAN5 gelten. Wenn in HBCI4Java also HKTAN/HITAN und HITANS 5
-                                // eingebaut ist, muss das hier beachtet werden. IMHO gibt es aber keine Aenderungen zwischen
-                                // hhd 1.3 und hhd 1.4
-                                //
-                                // Also etwa so:
-                                // String spec = "hhd12"; // Default
-                                // if (hktan_version > 2) spec = "hhd13"; // bei HKTAN3/HKTAN4
-                                // if (hktan_version > 4) spec = "hhd15"; // ab HKTAN5
-                                
-                                String   klass=cinfo.getKlassBySegCode(segcode,spec);
-                                HBCIUtils.log("using challenge klass "+klass, HBCIUtils.LOG_DEBUG2);
-                                hktan.setParam("challengeklass",klass);
-
-                                // die als challenge-param einzustellenden werte aus der challenge-info holen
-                                String[] param_paths=cinfo.getParamPathsBySegCode(segcode,spec);
-                                int      param_count=param_paths.length;
-                                for (int p=0;p<param_count;p++) {
-                                        String path=param_paths[p];
-                                        String value=task.getChallengeParam(path);
-                                        HBCIUtils.log("adding challenge parameter "+path+" = "+value, HBCIUtils.LOG_DEBUG2);
-                                        hktan.setParam("ChallengeKlassParam"+(p+1),value);
-                                }
-
-                                // wenn auch noch der betrag aus dem auftrag in die challenge-parameter
-                                // eingestellt werden soll, machen wir das (sofern ein wert existiert)
-                                if (secmechInfo.getProperty("needchallengevalue","N").equals("J")) {
-                                        HBCIUtils.log("we also have to add the value as challenge parameter",
-                                                        HBCIUtils.LOG_DEBUG);
-                                        
-                                        // pfad zum wert holen
-                                        String path=cinfo.getValuePathBySegCode(segcode,spec);
-                                        if (path!=null) {
-                                            // es ist tatschlich der pfad zu einem wert definiert
-                                            String value=task.getChallengeParam(path);
-                                            if (value!=null && value.length()!=0) {
-                                                value=new SyntaxWrt(value,1,0).toString(0);
-
-                                                HBCIUtils.log("adding challenge parameter "+path+" = "+value, 
-                                                        HBCIUtils.LOG_DEBUG2);
-                                                // der an dieser stelle gespeicherte wert ist nicht leer
-                                                hktan.setParam("ChallengeKlassParam"+(param_count+1),value);
-                                            }
-                                        }
-
-                                        // pfad zur whrung holen
-                                        path=cinfo.getCurrPathBySegCode(segcode,spec);
-                                        if (path!=null) {
-                                            // es gibt einen whrungs-eintrag
-                                            String value=task.getChallengeParam(path);
-                                            if (value!=null && value.length()!=0) {
-                                                // und es gibt auch eine whrung
-                                                HBCIUtils.log("adding challenge parameter "+path+" = "+value, 
-                                                        HBCIUtils.LOG_DEBUG2);
-                                                hktan.setParam("ChallengeKlassParam"+(param_count+2),value);
-                                            }
-                                        }
-                                }
-
-                                // willuhn 2011-05-09: Bei Bedarf noch das TAN-Medium erfragen
-                                applyTanMedia((GVTAN2Step) hktan);
+                            if (secmechInfo.getProperty("needchallengeklass","N").equals("J"))
+                            {
+                                HBCIUtils.log("we are in PV #1, and a challenge klass is required",HBCIUtils.LOG_DEBUG);
+                                ChallengeInfo cinfo = ChallengeInfo.getInstance();
+                                cinfo.applyParams(task,hktan,secmechInfo);
                             }
+
+                            // willuhn 2011-05-09: Bei Bedarf noch das TAN-Medium erfragen
+                            applyTanMedia((GVTAN2Step) hktan);
                             
                             // hktan-job zur neuen msg hinzufgen
                             additional_msg_tasks.add(hktan);
@@ -1114,8 +1075,8 @@
                             // TODO: das fr mehrfachsignaturen
                             // hktan2.setParam("notlasttan","J");
                             
-                            // willuhn 2011-05-09: Laut Spec (siehe applyTanMedia()) ist das TAN-Medium nur bei Prozess 1,3 und 4 noetig
-                            
+                            // willuhn 2011-05-09 TAN-Media gibts nur bei Prozess 1,3,4 - also nicht in hktan2
+
                             // hktan-job zur neuen msg hinzufgen
                             additional_msg_tasks.add(hktan2);
                             
